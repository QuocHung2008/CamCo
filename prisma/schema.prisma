generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique
  passwordHash String   @map("password_hash")
  role         Role
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  loans     Loan[]     @relation("LoanCreatedBy")
  auditLogs AuditLog[]

  @@map("users")
}

model Item {
  id          String   @id @default(uuid()) @db.Uuid
  itemName    String   @map("item_name")
  defaultWeightChi Decimal @map("default_weight_chi") @db.Decimal(10, 2)
  note        String   @default("")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([itemName], map: "ix_pawn_catalog_item_name")
  @@map("pawn_catalog")
}

model Loan {
  id                 String   @id @default(uuid()) @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customerName       String   @map("customer_name")
  customerNameSearch String   @default("") @map("customer_name_search")
  cccd               String
  recordNote         String   @default("") @map("note")
  totalAmountVnd     Decimal  @map("total_amount_vnd") @db.Decimal(18, 2)
  datePawn           DateTime @map("date_pawn") @db.Date
  createdById        String?  @map("created_by") @db.Uuid
  deletedAt          DateTime? @map("deleted_at") @db.Timestamptz(6)

  createdBy User?       @relation("LoanCreatedBy", fields: [createdById], references: [id])
  items     LoanItem[]

  @@index([datePawn], map: "ix_pawn_records_date_pawn")
  @@index([customerName], map: "ix_pawn_records_customer_name")
  @@index([customerNameSearch], map: "ix_pawn_records_customer_name_search")
  @@index([cccd], map: "ix_pawn_records_cccd")
  @@index([totalAmountVnd], map: "ix_pawn_records_total_amount_vnd")
  @@map("pawn_records")
}

model LoanItem {
  id            String   @id @default(uuid()) @db.Uuid
  loanId        String   @map("record_id") @db.Uuid
  qty           Int      @map("qty")
  itemName      String   @map("item_name")
  itemNameSearch String  @default("") @map("item_name_search")
  weightChi     Decimal  @map("weight_chi") @db.Decimal(10, 2)
  note          String   @default("")
  isRedeemed    Boolean  @default(false) @map("is_redeemed")
  redeemedAt    DateTime? @map("redeemed_at") @db.Timestamptz(6)

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId], map: "ix_pawn_items_record_id")
  @@index([itemNameSearch], map: "ix_pawn_items_item_name_search")
  @@index([isRedeemed], map: "ix_pawn_items_is_redeemed")
  @@map("pawn_items")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  action      String
  targetTable String?  @map("target_table")
  targetId    String?  @map("target_id") @db.Uuid
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], map: "idx_audit_user")
  @@index([createdAt], map: "idx_audit_created_at")
  @@map("audit_logs")
}
